{minimum_otp_vsn, "21.0"}.

{erl_opts, [debug_info,
            warn_export_all,
            warn_unused_vars,
            warn_shadow_vars,
            warn_unused_import,
            warn_obsolete_guard
           ]}.

{deps, [{cowlib, "2.12.1"},
        {gun, {git, "https://github.com/emqx/gun", {tag, "1.3.7"}}},
        {getopt, "1.0.2"}
       ]}.

{escript_name, emqtt_cli}.
{escript_main_app, emqtt}.
{escript_incl_apps, [getopt,gun,cowlib]}.
{escript_emu_args, "%%! -smp true +K true +A 16 +P 200000 -env ERL_MAX_PORTS 100000 -env ERTS_MAX_PORTS 100000\n"}.
{escript_shebang, "#!/usr/bin/env escript\n"}.

{profiles,
    [{test,
        [{deps,
            [ {meck, "0.9.2"}
            , {emqx, {git_subdir, "https://github.com/emqx/emqx", {branch, "master"}, "apps/emqx"}}
            , {emqx_limiter, {git_subdir, "https://github.com/emqx/emqx", {branch, "master"}, "apps/emqx/src/emqx_limiter"}}
            , {proper, "1.4.0"}
            ]},
         {erl_opts, [debug_info]},
         %% Define `TEST' in emqx to get empty `foreign_refereced_schema_apps'
         {overrides, [{add, emqx, [{erl_opts, [{d, 'TEST'}]}]}]}
        ]},
      {escript, []},
      {emqtt,
        [{relx,
          [{release, {emqtt, git_describe}, [
            kernel,
            sasl,
            crypto,
           public_key,
           asn1,
           syntax_tools,
           ssl,
           os_mon,
           inets,
           compiler,
           runtime_tools
         ]},
         {overlay_vars,["vars.config"]},
         {overlay, [
           {copy, "_build/escript/bin/emqtt_cli", "bin/emqtt_cli"},
           {copy,"bin/emqtt","bin/emqtt"},
           {template,"bin/emqtt","bin/emqtt"}
         ]},
         {include_src, false},
         {extended_start_script, false},
         {generate_start_script, false},
         {sys_config, false},
         {vm_args, false},
         {include_erts, true}
         ]}
        ]},
      {emqtt_pkg,
        [{relx,
        [{release, {emqtt, git_describe}, [
           kernel,
           sasl,
           crypto,
           public_key,
           asn1,
           syntax_tools,
           ssl,
           os_mon,
           inets,
           compiler,
           runtime_tools,
           quicer
         ]},
         {overlay_vars,["vars-pkg.config"]},
         {overlay, [
           {copy, "_build/escript/bin/emqtt_cli", "bin/emqtt_cli"},
           {copy,"bin/emqtt","bin/emqtt"},
           {template,"bin/emqtt","bin/emqtt"}
         ]},
         {include_src, false},
         {extended_start_script, false},
         {generate_start_script, false},
         {sys_config, false},
         {vm_args, false},
         {include_erts, true}
         ]

         }
        ]},
     %% test relup when emqtt is used as one dep app
     {emqtt_relup_test,
      [{relx,
        [{release, {emqtt, git_describe}, [
                                           kernel,
                                           sasl,
                                           crypto,
                                           public_key,
                                           asn1,
                                           syntax_tools,
                                           ssl,
                                           os_mon,
                                           inets,
                                           compiler,
                                           runtime_tools,
                                           emqtt
                                          ]},
         {include_src, false},
         {include_erts, true},
         {dev_mode, false},
         {overlay, [{copy, "{{ output_dir }}/ebin/emqtt.appup", "lib/{{ release }}/ebin/"}]}
        ]
       },
       {erl_opts, [{d, 'UPGRADE_TEST_CHEAT'}]}
      ]}

    ]}.

{cover_enabled, true}.
{cover_opts, [verbose]}.
{cover_export_enabled, true}.

{xref_checks, [undefined_function_calls]}.

{dialyzer_base_plt_apps,
 [kernel,
  stdlib,
  erts,
  sasl,
  ssl,
  syntax_tools,
  compiler,
  crypto]}.

{project_plugins, [{relup_helper,{git,"https://github.com/emqx/relup_helper", {tag, "2.0.0"}}}]}.
